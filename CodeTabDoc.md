# 1c-develop

Вывод в ТАБ ДОК


&НаКлиенте
Процедура ЗагрузкаExcel(Команда)
	Если Объект.ТаблицаSKU.Количество() > 0 Тогда
		ОписаниеОповещения = Новый ОписаниеОповещения("ПослеЗакрытияВопроса", ЭтаФорма);		
		ПоказатьВопрос(ОписаниеОповещения, "Табличная часть будет очищена и перезаполнена. Продолжить?", РежимДиалогаВопрос.ДаНет);
	Иначе	
		ЗагрузитьДанные();
	КонецЕсли;

КонецПроцедуры



&НаКлиенте
Процедура ЗагрузитьДанные()
	
	ДиалогВыбора = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);
	ДиалогВыбора.Заголовок = "Выбор файла";
	ДиалогВыбора.Фильтр = "Формат Excel (*.xls;*.xlsx)|*.xls;*.xlsx|"; 
	
	Если ДиалогВыбора.Выбрать() Тогда
		ИмяФайла = ДиалогВыбора.ПолноеИмяФайла;
	КонецЕсли;	
	
	Если ИмяФайла = Неопределено Тогда
		Возврат;
	КонецЕсли; 	
	
	ТабличныйДокумент = Новый ТабличныйДокумент;
	ТабличныйДокумент.Прочитать(ИмяФайла, СпособЧтенияЗначенийТабличногоДокумента.Значение);	
	
	ЗаполнитьТаблицуИзExcel(ТабличныйДокумент);		
	
КонецПроцедуры


&НаСервере
Процедура ЗаполнитьТаблицуИзExcel(ТабличныйДокумент)
	Отказ = Ложь;
	
	СчетчикСтрока = 1;
	СчетчикКолонка = 1;
	НайденаНепустаяЯчейка = Ложь;
	
	Для СчетчикСтрока = 1 По ТабличныйДокумент.ВысотаТаблицы Цикл 
		Для СчетчикКолонка = 1 По ТабличныйДокумент.ШиринаТаблицы Цикл 
			Ячейка = ТабличныйДокумент.Область(СчетчикСтрока, СчетчикКолонка);
			Если ЗначениеЗаполнено(Ячейка.Текст) Тогда
				НайденаНепустаяЯчейка = Истина;
				Прервать;
			КонецЕсли;	
		КонецЦикла;
		Если НайденаНепустаяЯчейка Тогда 
			Прервать;
		КонецЕсли;	
	КонецЦикла;	
	
	ПоследняяСтрока = ТабличныйДокумент.ВысотаТаблицы;
	ПоследняяКолонка = ТабличныйДокумент.ШиринаТаблицы;
	
	ОбластьЯчеек = ТабличныйДокумент.Область(СчетчикСтрока,СчетчикКолонка,ПоследняяСтрока,ПоследняяКолонка);
	
	ИсточникДанных = Новый ОписаниеИсточникаДанных(ОбластьЯчеек);
	ПостроительОтчета = Новый ПостроительОтчета;
	ПостроительОтчета.ИсточникДанных = ИсточникДанных;
	ПостроительОтчета.Выполнить();
	
	Таблица = ПостроительОтчета.Результат.Выгрузить();
	
	Если Таблица.Колонки.Найти("Контрагент") = Неопределено Тогда
		ТекстСообщения = "В документе Excel не найдена колонка ""Контрагент""";
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения, , , "Объект", Отказ);
	КонецЕсли; 
	
	Если Таблица.Колонки.Найти("Дата") = Неопределено Тогда
		ТекстСообщения = "В документе Excel не найдена колонка ""Дата""";
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения, , , "Объект", Отказ);
	КонецЕсли; 
	
	Если Таблица.Колонки.Найти("Вводы_Вывод") = Неопределено Тогда
		ТекстСообщения = "В документе Excel не найдена колонка ""Ввод/вывод""";
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения, , , "Объект", Отказ);
	КонецЕсли; 
	
	Если Таблица.Колонки.Найти("Номенклатура") = Неопределено Тогда
		ТекстСообщения = "В документе Excel не найдена колонка ""Номенклатура""";
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения, , , "Объект", Отказ);
	КонецЕсли; 
		
	Если Таблица.Колонки.Найти("ФедеральныйОкруг") = Неопределено Тогда
		ТекстСообщения = "В документе Excel не найдена колонка ""Ввод/вывод""";
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения, , , "Объект", Отказ);
	КонецЕсли; 
	
	Если Таблица.Колонки.Найти("Контрагент") = Неопределено Тогда
		ТекстСообщения = "В документе Excel не найдена колонка ""Ввод/вывод""";
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ТекстСообщения, , , "Объект", Отказ);
	КонецЕсли; 
	
	Если Отказ Тогда
		Возврат;
	КонецЕсли; 	
	
	Объект.ТаблицаSKU.Очистить();
	Таблица.Свернуть("Дата,Вводы_Вывод,Номенклатура,Характеристика,ФедеральныйОкруг,Менеджер,Контрагент,Коофицент");


	Для Каждого Строка Из Таблица Цикл
		Номенклатура = ?(Строка.Номенклатура = "", Неопределено, Справочники.Номенклатура.НайтиПоНаименованию(СокрЛП(Строка.Номенклатура)));

		Контрагент = Справочники.Контрагенты.НайтиПоНаименованию(СокрЛП(Строка.Контрагент));
		
		Если Контрагент.Пустая() Тогда
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю("Не найден контрагент " + "" + Строка.Контрагент + "");
			Продолжить;
		КонецЕсли; 
		
		Если Номенклатура = Неопределено ИЛИ Номенклатура.Пустая() Тогда
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю("Не найдена Номенклатура " + "" + Строка.Номенклатура + "");
			Продолжить;
			
		КонецЕсли;
		//Договор = Справочники.ДоговорыКонтрагентов.НайтиПоНаименованию(СокрЛП(Строка.Договор),,,Контрагент);
	//	ЛокальнаяСеть = Справочники.РМ_ЛокальныеСети.НайтиПоНаименованию(СокрЛП(Строка.ЛокальнаяСеть));
	
		
		НоваяСтрокаТаблица = Объект.ТаблицаSKU.Добавить();
		
		ДатаМассив = ОбщегоНазначенияЗК.РазложитьСтрокуВМассивПодстрок(Строка.Дата,".") ;
		
			
		Если ДатаМассив.Количество() = 3 Тогда    
			Если ТипЗнч(Строка.Дата) = Тип("дата") Тогда
			НоваяСтрокаТаблица.ДатаВводаВывода  = Строка.Дата ;//Дата(ДатаМассив[2]+ДатаМассив[1]+ДатаМассив[0]);
		Иначе
			НоваяСтрокаТаблица.ДатаВводаВывода  = Дата(ДатаМассив[2]+ДатаМассив[1]+ДатаМассив[0]);
			КонецЕсли;
		
	КонецЕсли;
	
		НоваяСтрокаТаблица.ВводВывод  =  ?(Строка.Вводы_Вывод = "Ввод","Ввод","Вывод");
		
				
		ФедОкруг = ?(Строка.ФедеральныйОкруг = "",СправочникИ.Регионы.ПустаяСсылка(),Справочники.Регионы.НайтиПоНаименованию(Строка.ФедеральныйОкруг));
		
		НоваяСтрокаТаблица.Номенклатура  = Номенклатура;
		НоваяСтрокаТаблица.Характеристика  = Справочники.ХарактеристикиНоменклатуры.НайтиПоНаименованию(СокрЛП(Строка.Характеристика),,,НоваяСтрокаТаблица.Номенклатура) ;
		НоваяСтрокаТаблица.ФедеральныйОкруг  = ФедОкруг ;
		НоваяСтрокаТаблица.Менеджер  = ?(Строка.Менеджер = "",Справочники.ФизическиеЛица.ПустаяСсылка(),Справочники.ФизическиеЛица.НайтиПоНаименованию(СокрЛП(Строка.Менеджер))) ;
		НоваяСтрокаТаблица.Контрагент  = Контрагент;
		НоваяСтрокаТаблица.Коофицент  = Строка.Коофицент ;

	КонецЦикла;	
	
	Модифицированность = Истина;
КонецПроцедуры
